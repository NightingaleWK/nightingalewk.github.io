{
    "version": "https://jsonfeed.org/version/1",
    "title": "雪漫城的风宅 • All posts by \"filament\" tag",
    "description": "この世界は好都合に未完成 だから知りたいんだ —— チ。-地球の運動について-",
    "home_page_url": "https://nightingalewk.cn",
    "items": [
        {
            "id": "https://nightingalewk.cn/2026/01/29/88.%20OSM%20%E7%A6%BB%E7%BA%BF%E5%9C%B0%E5%9B%BE%E6%9C%8D%E5%8A%A1%E7%A7%81%E6%9C%89%E5%8C%96%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88/",
            "url": "https://nightingalewk.cn/2026/01/29/88.%20OSM%20%E7%A6%BB%E7%BA%BF%E5%9C%B0%E5%9B%BE%E6%9C%8D%E5%8A%A1%E7%A7%81%E6%9C%89%E5%8C%96%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88/",
            "title": "OSM 离线地图服务私有化部署方案",
            "date_published": "2026-01-29T10:00:00.000Z",
            "content_html": "<h2 id=\"1-部署目标与环境\"><a href=\"#1-部署目标与环境\" class=\"headerlink\" title=\"1. 部署目标与环境\"></a>1. 部署目标与环境</h2><ul>\n<li><strong>目标</strong>：构建完全离线、内网可用的 OSM 瓦片地图服务，为 Filament (Laravel 12) 系统提供底层地图支持。</li>\n<li><strong>硬件环境</strong>：Dell Precision 7920 工作站 (Xeon Silver 4210R &#x2F; 32GB 内存 &#x2F; SSD RAID)。</li>\n<li><strong>数据范围</strong>：山东省全量矢量数据 (包含招远市全境)。</li>\n<li><strong>核心技术栈</strong>：Docker, PostgreSQL + PostGIS, Renderd, Apache&#x2F;Mod_tile。</li>\n</ul>\n<hr>\n<h2 id=\"2-核心部署流程-Docker\"><a href=\"#2-核心部署流程-Docker\" class=\"headerlink\" title=\"2. 核心部署流程 (Docker)\"></a>2. 核心部署流程 (Docker)</h2><p>为确保数据索引完整且避免镜像自动下载示例数据（卢森堡问题），采用<strong>全量导入 + 绝对路径挂载</strong>策略。</p>\n<h3 id=\"第一步：环境初始化\"><a href=\"#第一步：环境初始化\" class=\"headerlink\" title=\"第一步：环境初始化\"></a>第一步：环境初始化</h3><p>确保无脏数据残留。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">rm</span> -f osm-server</span><br><span class=\"line\">docker volume <span class=\"built_in\">rm</span> osm-data-volume</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"第二步：高性能数据导入-Import\"><a href=\"#第二步：高性能数据导入-Import\" class=\"headerlink\" title=\"第二步：高性能数据导入 (Import)\"></a>第二步：高性能数据导入 (Import)</h3><p>针对 Xeon 处理器和 SSD RAID 进行参数调优，最大化利用硬件性能。</p>\n<ul>\n<li><strong>源文件</strong>：<code>shandong-latest.osm.pbf</code> (约 67MB)。</li>\n<li><strong>挂载策略</strong>：必须将宿主机文件挂载到容器内的 <code>/data/region.osm.pbf</code>，以覆盖默认行为。</li>\n<li><strong>性能参数</strong>：</li>\n<li><code>THREADS=18</code>：利用多核并行处理。</li>\n<li><code>OSM2PGSQL_CACHE=8000</code>：分配 8GB 内存用于构建空间索引。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --<span class=\"built_in\">rm</span> \\</span><br><span class=\"line\">    -v /home/wangkai/code/osm/shandong-260128.osm.pbf:/data/region.osm.pbf \\</span><br><span class=\"line\">    -v osm-data-volume:/var/lib/postgresql/15/main \\</span><br><span class=\"line\">    -e THREADS=18 \\</span><br><span class=\"line\">    -e OSM2PGSQL_CACHE=8000 \\</span><br><span class=\"line\">    overv/openstreetmap-tile-server \\</span><br><span class=\"line\">    import</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"第三步：启动服务-Run\"><a href=\"#第三步：启动服务-Run\" class=\"headerlink\" title=\"第三步：启动服务 (Run)\"></a>第三步：启动服务 (Run)</h3><p>启动渲染引擎与 Web 服务。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -p 8080:80 \\</span><br><span class=\"line\">    -v osm-data-volume:/var/lib/postgresql/15/main \\</span><br><span class=\"line\">    -d --name osm-server \\</span><br><span class=\"line\">    overv/openstreetmap-tile-server \\</span><br><span class=\"line\">    run</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"3-服务可用性验证\"><a href=\"#3-服务可用性验证\" class=\"headerlink\" title=\"3. 服务可用性验证\"></a>3. 服务可用性验证</h2><h3 id=\"方式-A：数据库层核验\"><a href=\"#方式-A：数据库层核验\" class=\"headerlink\" title=\"方式 A：数据库层核验\"></a>方式 A：数据库层核验</h3><p>通过 SQL 确认地理实体是否已入库（以招远地标为例）。</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 验证道路数据</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> name, ST_AsText(way) <span class=\"keyword\">FROM</span> planet_osm_line <span class=\"keyword\">WHERE</span> name <span class=\"operator\">=</span> <span class=\"string\">&#x27;罗峰路&#x27;</span>;</span><br><span class=\"line\"><span class=\"comment\">-- 验证区域数据</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> name <span class=\"keyword\">FROM</span> planet_osm_point <span class=\"keyword\">WHERE</span> name <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;%招远%&#x27;</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方式-B：瓦片服务直连\"><a href=\"#方式-B：瓦片服务直连\" class=\"headerlink\" title=\"方式 B：瓦片服务直连\"></a>方式 B：瓦片服务直连</h3><p>访问招远市中心坐标对应的瓦片 URL，确认渲染正常。</p>\n<ul>\n<li><strong>测试地址</strong>：<code>http://localhost:8080/tile/15/27331/13146.png</code></li>\n<li><strong>预期结果</strong>：返回包含中文街道信息的 PNG 图片。</li>\n</ul>\n<hr>\n<h2 id=\"4-前端集成方案-Filament-PHP\"><a href=\"#4-前端集成方案-Filament-PHP\" class=\"headerlink\" title=\"4. 前端集成方案 (Filament PHP)\"></a>4. 前端集成方案 (Filament PHP)</h2><p>在 Laravel&#x2F;Filament 系统中接入离线底图。核心逻辑是<strong>锁定初始视口</strong>，确保用户打开地图即聚焦于目标区域。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">DotsWan</span>\\<span class=\"title\">FilamentMap</span>\\<span class=\"title\">Fields</span>\\<span class=\"title\">Map</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"built_in\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">form</span>(<span class=\"params\">Form <span class=\"variable\">$form</span></span>): <span class=\"title\">Form</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable\">$form</span>-&gt;<span class=\"title function_ invoke__\">schema</span>([</span><br><span class=\"line\">        <span class=\"title class_\">Map</span>::<span class=\"title function_ invoke__\">make</span>(<span class=\"string\">&#x27;location&#x27;</span>)</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">label</span>(<span class=\"string\">&#x27;地理位置选择&#x27;</span>) // 通用标签</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">leafletOptions</span>([</span><br><span class=\"line\">                // 指向本地 Docker 瓦片服务</span><br><span class=\"line\">                <span class=\"string\">&#x27;tileLayer&#x27;</span> =&gt; <span class=\"string\">&#x27;http://localhost:8080/tile/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;attribution&#x27;</span> =&gt; <span class=\"string\">&#x27;© OpenStreetMap contributors&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;maxZoom&#x27;</span> =&gt; <span class=\"number\">18</span>,</span><br><span class=\"line\">            ])</span><br><span class=\"line\">            // 【关键配置】初始化聚焦坐标：招远市中心</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">defaultLocation</span>([<span class=\"number\">37.3615</span>, <span class=\"number\">120.4042</span>]) </span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">zoom</span>(<span class=\"number\">15</span>) // 街道级默认缩放</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">clickable</span>(<span class=\"literal\">true</span>)</span><br><span class=\"line\">    ]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<p>·</p>\n<h2 id=\"5-扩展方案：自定义区域切割-可选\"><a href=\"#5-扩展方案：自定义区域切割-可选\" class=\"headerlink\" title=\"5. 扩展方案：自定义区域切割 (可选)\"></a>5. 扩展方案：自定义区域切割 (可选)</h2><p>若需剥离特定行政区划（如仅保留招远市轮廓），可使用 <code>osmium</code> 工具链。</p>\n<ol>\n<li><strong>定义边界</strong>：使用 <a href=\"https://geojson.io/\">GeoJSON</a> 定义多边形范围，并导出为 zhaoyuan.geojson。</li>\n<li><strong>执行切割</strong>：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">osmium extract -p zhaoyuan.geojson shandong-latest.osm.pbf -o zhaoyuan.osm.pbf</span><br></pre></td></tr></table></figure></li>\n<li><strong>重载数据</strong>：使用新生成的 <code>.pbf</code> 文件重复“第二步”导入流程。</li>\n</ol>\n<hr>\n<h2 id=\"6-运维参数\"><a href=\"#6-运维参数\" class=\"headerlink\" title=\"6. 运维参数\"></a>6. 运维参数</h2><ul>\n<li><p><strong>资源占用</strong>：</p>\n</li>\n<li><p>磁盘：约 2GB - 3GB (含数据库与基础缓存)。</p>\n</li>\n<li><p>内存：建议预留 4GB 以上给 Docker 容器。</p>\n</li>\n<li><p><strong>数据更新</strong>：只需下载最新的山东省 PBF 文件，重新执行 Clean -&gt; Import 流程即可（耗时 &lt; 5分钟）。</p>\n</li>\n<li><p><strong>网络要求</strong>：部署过程中需短暂联网下载全球水体数据（约 800MB），之后运行过程<strong>完全离线</strong>。</p>\n</li>\n</ul>\n",
            "tags": [
                "Docker",
                "OSM",
                "PostGIS",
                "Filament"
            ]
        }
    ]
}