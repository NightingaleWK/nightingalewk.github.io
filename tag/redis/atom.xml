<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://nightingalewk.cn</id>
    <title>雪漫城的风宅 • Posts by &#34;redis&#34; tag</title>
    <link href="https://nightingalewk.cn" />
    <updated>2022-12-14T08:48:00.000Z</updated>
    <category term="迁移" />
    <category term="hexo" />
    <category term="主食" />
    <category term="电脑维修" />
    <category term="学习笔记" />
    <category term="pr" />
    <category term="bilibili" />
    <category term="热菜" />
    <category term="梦境" />
    <category term="甜品" />
    <category term="汤" />
    <category term="海鲜" />
    <category term="homestead" />
    <category term="代码更新" />
    <category term="oneinstack" />
    <category term="lnmp" />
    <category term="代码部署" />
    <category term="dcat admin" />
    <category term="oh-my-zsh" />
    <category term="debug" />
    <category term="指令" />
    <category term="道歉信" />
    <category term="免密" />
    <category term="vs code" />
    <category term="laravel sail" />
    <category term="PAC 清单" />
    <category term="fileinfo" />
    <category term="定时任务" />
    <category term="gpg" />
    <category term="sshppass" />
    <category term="awk" />
    <category term="net time" />
    <category term="swap" />
    <category term="端口查询" />
    <category term="表单验证" />
    <category term="事件" />
    <category term="blade" />
    <category term="wordpress" />
    <category term="队列" />
    <category term="redis" />
    <category term="特色小吃" />
    <category term="粥" />
    <category term="Cloudreve" />
    <category term="故障排除" />
    <category term="artisan 指令" />
    <category term="Font Awesome" />
    <category term="vite" />
    <category term="linux" />
    <category term="我的世界" />
    <category term="Minecraft" />
    <category term="膝盖中箭之地" />
    <category term="领域" />
    <category term="realms" />
    <category term="公告" />
    <category term="screen" />
    <category term="cursor" />
    <category term="人工智能" />
    <category term="prompt" />
    <category term="打印机" />
    <category term="京瓷" />
    <category term="教程" />
    <category term="Git" />
    <category term="GitHub" />
    <category term="版本控制" />
    <category term="Monorepo" />
    <category term="DevOps" />
    <category term="Laravel" />
    <category term="Docker" />
    <category term="容器化" />
    <category term="部署" />
    <category term="运维" />
    <category term="国产化" />
    <category term="信创" />
    <category term="TongHttpServer" />
    <category term="Ubuntu" />
    <category term="安装指南" />
    <category term="阿里云" />
    <category term="镜像源" />
    <category term="Rule" />
    <category term="Prompt" />
    <category term="gemini" />
    <category term="Nginx" />
    <category term="反向代理" />
    <category term="NPM" />
    <category term="HTTPS" />
    <category term="问题排查" />
    <category term="Sail" />
    <category term="WSL2" />
    <category term="Artisan" />
    <category term="Composer" />
    <category term="Troubleshooting" />
    <category term="Hardware" />
    <category term="Tooling" />
    <entry>
        <id>https://nightingalewk.cn/2022/12/14/52.%20%E5%8F%91%E8%B5%B7%20laravel%20%E9%98%9F%E5%88%97%E4%BB%BB%E5%8A%A1%E4%B8%8D%E7%94%9F%E6%95%88/</id>
        <title>发起 laravel 队列任务不生效</title>
        <link rel="alternate" href="https://nightingalewk.cn/2022/12/14/52.%20%E5%8F%91%E8%B5%B7%20laravel%20%E9%98%9F%E5%88%97%E4%BB%BB%E5%8A%A1%E4%B8%8D%E7%94%9F%E6%95%88/"/>
        <content type="html">&lt;p&gt;当确定你的代码都没问题，而且队列都在运行，而且是你变动了 job 文件，那很有可能是缓存原因导致的，清理一下&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;php artisan cache:clear &amp;amp;&amp;amp; php artisan config:clear &amp;amp;&amp;amp; php artisan route:clear &amp;amp;&amp;amp; php artisan view:clear&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;若是在 laravel sail 开发环境中，修改一下即可使用：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sail artisan cache:clear &amp;amp;&amp;amp; sail artisan config:clear &amp;amp;&amp;amp; sail artisan route:clear &amp;amp;&amp;amp; sail artisan view:clear&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;花式清理后就好了&lt;/p&gt;
</content>
        <category term="debug" />
        <category term="队列" />
        <category term="redis" />
        <updated>2022-12-14T08:48:00.000Z</updated>
    </entry>
    <entry>
        <id>https://nightingalewk.cn/2022/12/09/51.%20%E5%9C%A8%20laravel%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20redis%20%E9%98%9F%E5%88%97/</id>
        <title>在 laravel 中使用 redis 队列</title>
        <link rel="alternate" href="https://nightingalewk.cn/2022/12/09/51.%20%E5%9C%A8%20laravel%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20redis%20%E9%98%9F%E5%88%97/"/>
        <content type="html">&lt;p&gt;我们实现的效果为：将一些业务逻辑转化为任务（job），然后启用队列功能，而且是 redis 的队列，同时使用 laravel 官方扩展 Horizon 实现队列的监控。将复杂耗时的工作后台处理，提高前台用户的使用体验。&lt;/p&gt;
&lt;h2 id=&#34;1-安装-redis&#34;&gt;&lt;a href=&#34;#1-安装-redis&#34; class=&#34;headerlink&#34; title=&#34;1. 安装 redis&#34;&gt;&lt;/a&gt;1. 安装 redis&lt;/h2&gt;&lt;p&gt;注意不要使用国内 composer 源，官方的是最全最新的（什么阿里云镜像源反向升级了解一下）&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;composer require predis/predis&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修改环境变量 QUEUE_CONNECTION 的值为 redis，并指定我们将使用 predis 作为请求 Redis 的类库：&lt;/p&gt;
&lt;p&gt;.env&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;QUEUE_CONNECTION=redis&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;REDIS_CLIENT=predis&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;2-生成任务类&#34;&gt;&lt;a href=&#34;#2-生成任务类&#34; class=&#34;headerlink&#34; title=&#34;2. 生成任务类&#34;&gt;&lt;/a&gt;2. 生成任务类&lt;/h2&gt;&lt;p&gt;使用以下 Artisan 命令来生成一个新的队列任务：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ php artisan make:job EnterpriseExport&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;该命令会在 app&amp;#x2F;Jobs 目录下生成一个新的类：&lt;/p&gt;
&lt;p&gt;app&amp;#x2F;Jobs&amp;#x2F;EnterpriseExport.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;namespace App\Jobs;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use App\Admin\Controllers\Api\StaticFun;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use App\Models\Asset;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Bus\Queueable;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Contracts\Queue\ShouldBeUnique;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Contracts\Queue\ShouldQueue;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Foundation\Bus\Dispatchable;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Queue\InteractsWithQueue;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Queue\SerializesModels;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;use Illuminate\Support\Facades\DB;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class GetAssetsRemainDate implements ShouldQueue, ShouldBeUnique&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    /**&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     * Create a new job instance.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     *&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     * @return void&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    /**&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     * Execute the job.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     *&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     * @return void&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function handle()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 拿到全部资产信息&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $assets = Asset::all();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 开始循环计算资产剩余质保时间并更新&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        foreach ($assets as $key =&amp;gt; $value) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            // 计算&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $warranty_info = StaticFun::get2DateInfo($value-&amp;gt;warranty_start, $value-&amp;gt;warranty_end);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            // 拿取&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $warranty_remain = $warranty_info[&amp;#x27;warranty_remain&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            // 更新写入&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            DB::table(&amp;#x27;asset&amp;#x27;)-&amp;gt;where(&amp;#x27;id&amp;#x27;, $value-&amp;gt;id)-&amp;gt;update([&amp;#x27;warranty_remain&amp;#x27; =&amp;gt; $warranty_remain]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;还有一点需要注意，我们将会在模型监控器中分发任务，任务中要避免使用 Eloquent 模型接口调用，如：create(), update(), save() 等操作。否则会陷入调用死循环 —— 模型监控器分发任务，任务触发模型监控器，模型监控器再次分发任务，任务再次触发模型监控器… 死循环。在这种情况下，使用 DB 类直接对数据库进行操作即可。&lt;/p&gt;
&lt;h2 id=&#34;3-任务分发&#34;&gt;&lt;a href=&#34;#3-任务分发&#34; class=&#34;headerlink&#34; title=&#34;3. 任务分发&#34;&gt;&lt;/a&gt;3. 任务分发&lt;/h2&gt;&lt;p&gt;前往控制器或者观察者，去插入这项任务。&lt;/p&gt;
&lt;p&gt;SettingController.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class SettingController extends Controller&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    // 展示&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function index(Content $content)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return $content&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            -&amp;gt;header(&amp;#x27;系统设置&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            -&amp;gt;description(&amp;#x27;亲自参与到系统的个性化管理&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            -&amp;gt;body(function (Row $row) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                $row-&amp;gt;column(12, Setting::index());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    // 刷新资产质保剩余时间&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function warrantyRefresh()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        dispatch(new GetAssetsRemainDate);  &amp;lt;-- HERE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return redirect(&amp;#x27;/admin/setting&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;4-安装-Horizon&#34;&gt;&lt;a href=&#34;#4-安装-Horizon&#34; class=&#34;headerlink&#34; title=&#34;4. 安装 Horizon&#34;&gt;&lt;/a&gt;4. 安装 Horizon&lt;/h2&gt;&lt;p&gt;使用 Composer 安装：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ composer require laravel/horizon&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;安装完成后，使用 vendor:publish Artisan 命令发布相关文件：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ php artisan vendor:publish --provider=&amp;quot;laravel\Horizon\HorizonServiceProvider&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;分别是配置文件 config&amp;#x2F;horizon.php 和存放在 public&amp;#x2F;vendor&amp;#x2F;horizon 文件夹中的 CSS 、JS 等页面资源文件。&lt;/p&gt;
&lt;p&gt;Horizon 是一个监控程序，需要常驻运行，我们可以通过以下命令启动：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ php artisan horizon&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;至此安装完毕，浏览器打开 larabbs.test&amp;#x2F;horizon 访问控制台&lt;/p&gt;
&lt;h2 id=&#34;5-安装-Supervisor&#34;&gt;&lt;a href=&#34;#5-安装-Supervisor&#34; class=&#34;headerlink&#34; title=&#34;5. 安装 Supervisor&#34;&gt;&lt;/a&gt;5. 安装 Supervisor&lt;/h2&gt;&lt;p&gt;Supervisor 是一个用于 Linux 操作系统的进程监视器。如果 Horizon 进程被退出或终止，Supervisor 将自动重启你的 Horizon 进程。如果要在 Ubuntu 上安装 Supervisor，你可以使用以下命令。如果你不使用 Ubuntu，也可以使用操作系统的包管理器安装 Supervisor：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sudo apt-get install supervisor&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;6-配置-Supervisor&#34;&gt;&lt;a href=&#34;#6-配置-Supervisor&#34; class=&#34;headerlink&#34; title=&#34;6. 配置 Supervisor&#34;&gt;&lt;/a&gt;6. 配置 Supervisor&lt;/h2&gt;&lt;p&gt;Supervisor 配置文件通常存储在 &amp;#x2F;etc&amp;#x2F;supervisor&amp;#x2F;conf.d 目录下。在此目录中，你可以创建任意数量的配置文件，这些配置文件会告诉 supervisor 如何监视你的进程。例如，让我们创建一个 horizon.conf 文件，它启动并监视一个 horizon 进程：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[program:horizon]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;process_name=%(program_name)s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;directory=/data/wwwroot/yanji.wkarrow.top&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;command=/usr/local/php/bin/php artisan horizon&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;autostart=true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;autorestart=true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;user=root&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;stopasgroup=true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;killasgroup=true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;redirect_stderr=true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;stdout_logfile=/data/wwwroot/yanji.wkarrow.top/horizon.log&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;stopwaitsecs=3600&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：要确保 stopwaitsecs 的值大于运行时间最长的任务所消耗的秒数。否则，Supervisor 可能会在工作完成前终止任务。&lt;br&gt;注意：编辑文件之前，请使用 root 权限进行操作，否则无法保存（针对 homestead 环境下的操作）&lt;/p&gt;
&lt;h2 id=&#34;7-启动-Supervisor&#34;&gt;&lt;a href=&#34;#7-启动-Supervisor&#34; class=&#34;headerlink&#34; title=&#34;7. 启动 Supervisor&#34;&gt;&lt;/a&gt;7. 启动 Supervisor&lt;/h2&gt;&lt;p&gt;在将新代码部署到服务器时，你需要终止 Horizon 主进程，以便进程监视器重新启动它并接收代码的更改。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;php artisan horizon:terminate&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;创建了配置文件后，可以使用以下命令更新 Supervisor 配置并启动进程：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sudo supervisorctl reread&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sudo supervisorctl update&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sudo supervisorctl start horizon&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
        <category term="队列" />
        <category term="redis" />
        <updated>2022-12-09T08:04:00.000Z</updated>
    </entry>
</feed>
