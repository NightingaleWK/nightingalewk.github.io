{
    "version": "https://jsonfeed.org/version/1",
    "title": "雪漫城的风宅 • All posts by \"docker\" category",
    "description": "この世界は好都合に未完成 だから知りたいんだ —— チ。-地球の運動について-",
    "home_page_url": "https://nightingalewk.cn",
    "items": [
        {
            "id": "https://nightingalewk.cn/2025/10/13/80.%20Laravel%20%E9%A1%B9%E7%9B%AE%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%90%8E%EF%BC%8C%E8%B5%84%E6%BA%90%E9%93%BE%E6%8E%A5%E5%A4%9A%E5%87%BA%E4%B8%AA%2080%20%E7%AB%AF%E5%8F%A3%E5%AD%97%E6%A0%B7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",
            "url": "https://nightingalewk.cn/2025/10/13/80.%20Laravel%20%E9%A1%B9%E7%9B%AE%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%90%8E%EF%BC%8C%E8%B5%84%E6%BA%90%E9%93%BE%E6%8E%A5%E5%A4%9A%E5%87%BA%E4%B8%AA%2080%20%E7%AB%AF%E5%8F%A3%E5%AD%97%E6%A0%B7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",
            "title": "Laravel 项目容器化部署生产环境后，资源链接多出个 80 端口字样解决方案",
            "date_published": "2025-10-13T02:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近在阿里云服务器上部署一个基于 Laravel 12 + Filament v4 的项目（代号“土豆食堂”），使用 Docker Compose 容器化部署，后端 Nginx + PHP-FPM，前端通过 Nginx Proxy Manager (NPM) 实现 HTTPS 反向代理。部署完成后，一切看似正常，但访问应用时发现前端资源（如 Filament 的 <code>app.js</code>）的 URL 被错误生成成 <code>https://lynx.wkarrow.top:80/js/filament/filament/app.js?v=4.1.6.0</code>，多出的 <code>:80</code> 端口导致浏览器无法加载资源，报 404 错误。</p>\n<p>这不是代码 bug，而是典型的 HTTPS 代理到 HTTP 后端的头部传递问题。NPM 默认将 <code>X-Forwarded-Port</code> 设置为后端端口 80，而 Laravel 在生成资产 URL 时会根据此头部附加端口，导致与 HTTPS scheme 不匹配。</p>\n<p>本文记录了问题排查与最终解决方案，重点分享后端 Nginx 的备选修复方法（适用于 NPM 配置无效的情况）。希望对类似部署遇到坑的开发者有帮助！</p>\n<h2 id=\"问题复现与分析\"><a href=\"#问题复现与分析\" class=\"headerlink\" title=\"问题复现与分析\"></a>问题复现与分析</h2><h3 id=\"环境概述\"><a href=\"#环境概述\" class=\"headerlink\" title=\"环境概述\"></a>环境概述</h3><ul>\n<li><strong>项目</strong>：Laravel 12 + Filament v4，使用 Vite 构建前端资源。</li>\n<li><strong>部署</strong>：Docker Compose（<code>docker-compose.internet.yml</code>），包含 app (PHP-FPM)、nginx、mysql、redis 等服务。</li>\n<li><strong>代理</strong>：NPM 监听 443 端口，强制 HTTPS，转发到后端 Nginx 的 80 端口。</li>\n<li><strong>Nginx 配置</strong>：<code>default.conf</code> 中已传递 <code>X-Forwarded-*</code> 头部到 PHP-FPM。</li>\n</ul>\n<h3 id=\"故障现象\"><a href=\"#故障现象\" class=\"headerlink\" title=\"故障现象\"></a>故障现象</h3><ul>\n<li>正常预期：<code>https://lynx.wkarrow.top/js/filament/filament/app.js?v=4.1.6.0</code></li>\n<li>实际生成：<code>https://lynx.wkarrow.top:80/js/filament/filament/app.js?v=4.1.6.0</code></li>\n<li>影响：浏览器 Network 面板显示资源 404，应用界面 JS&#x2F;CSS 加载失败，Filament 面板无法交互。</li>\n</ul>\n<h3 id=\"根因分析\"><a href=\"#根因分析\" class=\"headerlink\" title=\"根因分析\"></a>根因分析</h3><ol>\n<li>NPM 作为前端代理，添加 <code>X-Forwarded-Proto: https</code> 和 <code>X-Forwarded-Port: 80</code>（后端端口）。</li>\n<li>后端 Nginx 将这些头部传递给 PHP-FPM（<code>fastcgi_param HTTP_X_FORWARDED_PORT $http_x_forwarded_port;</code>）。</li>\n<li>Laravel 的 <code>Request</code> 对象信任代理头部（<code>config/trustedproxies.php</code>），读取 <code>X-Forwarded-Port=80</code>。</li>\n<li>URL 生成器（如 <code>asset()</code> 或 Filament 的资源 URL）检测到端口非 HTTPS 默认 443，故附加 <code>:80</code>。</li>\n<li>参考 Laravel 12 文档（HTTP Requests 部分）：<code>request()-&gt;getPort()</code> 优先从 <code>X-Forwarded-Port</code> 取值，导致畸形 URL。</li>\n</ol>\n<p>这是一个常见痛点，尤其在 Docker + 反向代理环境中。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>我先尝试了在 NPM 的 Advanced 选项卡添加 <code>proxy_set_header X-Forwarded-Port 443;</code>，但由于 NPM 的自定义配置有时不稳定（可能与版本或缓存相关），最终选择了后端 Nginx 的备选修复——直接在 <code>default.conf</code> 中覆盖端口逻辑。这方法更可靠，且不依赖代理工具。</p>\n<h3 id=\"步骤：修改后端-Nginx-配置\"><a href=\"#步骤：修改后端-Nginx-配置\" class=\"headerlink\" title=\"步骤：修改后端 Nginx 配置\"></a>步骤：修改后端 Nginx 配置</h3><ol>\n<li><p><strong>编辑配置文件</strong>：在项目目录下，打开 <code>./docker-internet/nginx/default.conf</code>（或挂载路径 <code>/etc/nginx/conf.d/default.conf</code>）。</p>\n</li>\n<li><p><strong>定位 PHP 处理块</strong>：找到 <code>location ~ \\.php$</code> 部分（已存在 FastCGI 配置）。</p>\n</li>\n<li><p><strong>添加覆盖逻辑</strong>：在 <code>fastcgi_param</code> 相关行后，插入以下 Nginx 指令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location ~ \\.php$ &#123;</span><br><span class=\"line\">    try_files $uri =404;</span><br><span class=\"line\">    fastcgi_split_path_info ^(.+\\.php)(/.+)$;</span><br><span class=\"line\">    fastcgi_pass app:9000;</span><br><span class=\"line\">    fastcgi_index index.php;</span><br><span class=\"line\">    include fastcgi_params;</span><br><span class=\"line\">    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class=\"line\">    fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class=\"line\"></span><br><span class=\"line\">    # 原有头部传递</span><br><span class=\"line\">    fastcgi_param HTTP_X_FORWARDED_FOR $http_x_forwarded_for;</span><br><span class=\"line\">    fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;</span><br><span class=\"line\">    fastcgi_param HTTP_X_FORWARDED_HOST $http_x_forwarded_host;</span><br><span class=\"line\">    fastcgi_param HTTP_X_FORWARDED_PORT $http_x_forwarded_port;</span><br><span class=\"line\"></span><br><span class=\"line\">    # 新增：基于 proto 覆盖端口，确保 HTTPS 时为 443</span><br><span class=\"line\">    set $real_port $http_x_forwarded_port;</span><br><span class=\"line\">    if ($http_x_forwarded_proto = &quot;https&quot;) &#123;</span><br><span class=\"line\">        set $real_port &quot;443&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    fastcgi_param HTTP_X_FORWARDED_PORT $real_port;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>解释</strong>：<ul>\n<li><code>set $real_port $http_x_forwarded_port;</code>：默认使用传入端口。</li>\n<li><code>if ($http_x_forwarded_proto = &quot;https&quot;) &#123; set $real_port &quot;443&quot;; &#125;</code>：如果 scheme 是 HTTPS，则强制覆盖为 443（忽略后端 80）。</li>\n<li>最后用 <code>$real_port</code> 替换原参数，确保 Laravel 读取正确端口。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>保存并重启服务</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker compose -f docker-compose.internet.yml restart nginx</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Nginx 会优雅重载，无需重建整个容器。</li>\n</ul>\n</li>\n<li><p><strong>辅助优化</strong>（可选，但推荐）：</p>\n<ul>\n<li>确认 <code>.env</code> 中的 <code>APP_URL=https://lynx.wkarrow.top</code>（无端口）。</li>\n<li>清除 Laravel 缓存：<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker compose -f docker-compose.internet.yml exec app php artisan config:clear</span><br><span class=\"line\">sudo docker compose -f docker-compose.internet.yml exec app php artisan cache:clear</span><br><span class=\"line\">sudo docker compose -f docker-compose.internet.yml exec app php artisan optimize</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h2 id=\"验证与测试\"><a href=\"#验证与测试\" class=\"headerlink\" title=\"验证与测试\"></a>验证与测试</h2><ul>\n<li><strong>浏览器测试</strong>：清空缓存，访问 <code>https://lynx.wkarrow.top</code>，打开 F12 &gt; Network，检查资源 URL（如 <code>app.js</code>）是否无 <code>:80</code>，并确认 200 OK。</li>\n<li><strong>命令行验证</strong>：<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -I https://lynx.wkarrow.top/js/filament/filament/app.js</span><br></pre></td></tr></table></figure>\n预期返回 200，无重定向或 404。</li>\n<li><strong>日志检查</strong>：若仍有问题，查看容器日志：<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker compose -f docker-compose.internet.yml logs nginx app | grep -i &quot;forwarded\\|port&quot;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>修复后，Filament 面板加载顺畅，前端交互完美！</p>\n<h2 id=\"总结与建议\"><a href=\"#总结与建议\" class=\"headerlink\" title=\"总结与建议\"></a>总结与建议</h2><p>这个坑让我意识到，在容器化部署中，代理头部的处理至关重要。优先尝试 NPM 的 Advanced 配置，如果无效，后端 Nginx 的 <code>if</code> 逻辑是稳妥备选。未来更新项目时，记得 git pull 后检查此配置是否覆盖。</p>\n<p>如果您也遇到类似问题，欢迎评论区交流！项目源码在 <a href=\"https://github.com/NightingaleWK/lynx\">GitHub</a> 开源中，星标支持下～</p>\n<p><strong>参考</strong>：</p>\n<ul>\n<li>Laravel 12 文档：HTTP Requests</li>\n<li>Nginx Proxy Manager 官方指南：Advanced Tab</li>\n</ul>\n<hr>\n<p><em>本文基于实际部署经验撰写，如有疑问，欢迎讨论。</em></p>\n",
            "tags": [
                "Docker",
                "Laravel",
                "Nginx",
                "反向代理",
                "NPM",
                "HTTPS",
                "问题排查"
            ]
        },
        {
            "id": "https://nightingalewk.cn/2025/10/10/79.%20%E5%9C%A8%20Ubuntu%2024.04%20%E7%94%A8%20APT%20%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%9A%84%20Docker%20Engine%20%E7%9A%84%E6%96%B9%E6%B3%95/",
            "url": "https://nightingalewk.cn/2025/10/10/79.%20%E5%9C%A8%20Ubuntu%2024.04%20%E7%94%A8%20APT%20%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%9A%84%20Docker%20Engine%20%E7%9A%84%E6%96%B9%E6%B3%95/",
            "title": "在 Ubuntu 24.04 用 APT 安装最新的 Docker Engine 的方法",
            "date_published": "2025-10-10T02:00:00.000Z",
            "content_html": "<p>文本将记录当前如何在阿里云 CES 服务器上，使用 APT 方式，安装最新的 Docker Engine 到 Ubuntu Server 24.04 上。主要解决的是国内因网络环境导致的资源无法下载、获取的问题。</p>\n<p>本文全部操作是基于<a href=\"https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository\">官方的完整文档</a>，仅对网络故障进行了处理，其他步骤均未改变。</p>\n<h2 id=\"1-设置-Docker-的-apt-存储库\"><a href=\"#1-设置-Docker-的-apt-存储库\" class=\"headerlink\" title=\"1. 设置 Docker 的 apt 存储库\"></a>1. 设置 Docker 的 apt 存储库</h2><p>在全新干净的服务器上，配置 apt 存储库，原本官方的方法是这样的：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Add Docker&#x27;s official GPG key:</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt-get update</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt-get install ca-certificates curl</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">chmod</span> a+r /etc/apt/keyrings/docker.asc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Add the repository to Apt sources:</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\</span><br><span class=\"line\">  <span class=\"string\">&quot;deb [arch=<span class=\"subst\">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \\</span></span><br><span class=\"line\"><span class=\"string\">  <span class=\"subst\">$(. /etc/os-release &amp;&amp; echo <span class=\"string\">&quot;<span class=\"variable\">$&#123;UBUNTU_CODENAME:-<span class=\"variable\">$VERSION_CODENAME</span>&#125;</span>&quot;</span>)</span> stable&quot;</span> | \\</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt-get update</span><br></pre></td></tr></table></figure>\n\n<p>很明显，基于 docker.com 的资源都被墙的七七八八了，根本无法顺利执行完毕，我们这里替换阿里源：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加阿里云镜像站的 Docker GPG Key:</span></span><br><span class=\"line\">apt update</span><br><span class=\"line\">apt install ca-certificates curl</span><br><span class=\"line\">install -m 0755 -d /etc/apt/keyrings</span><br><span class=\"line\">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加阿里云的 Docker APT 软件源（替换官方源）</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\</span><br><span class=\"line\">  <span class=\"string\">&quot;deb [arch=<span class=\"subst\">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \\</span></span><br><span class=\"line\"><span class=\"string\">  <span class=\"subst\">$(. /etc/os-release &amp;&amp; echo <span class=\"string\">&quot;<span class=\"variable\">$&#123;UBUNTU_CODENAME:-<span class=\"variable\">$VERSION_CODENAME</span>&#125;</span>&quot;</span>)</span> stable&quot;</span> | \\</span><br><span class=\"line\">  <span class=\"built_in\">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再次更新索引</span></span><br><span class=\"line\">apt update</span><br></pre></td></tr></table></figure>\n\n<p>这里，若我们使用的是 debian 等其他的发行版，则需要将上述的 <code>https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg</code> 替换为 <code>https://mirrors.aliyun.com/docker-ce/linux/debian/gpg</code> 即可。也就是 <code>ubuntu</code> 改为 <code>debian</code>，其他操作系统以此类推。</p>\n<h2 id=\"2-安装-Docker-包\"><a href=\"#2-安装-Docker-包\" class=\"headerlink\" title=\"2. 安装 Docker 包\"></a>2. 安装 Docker 包</h2><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>\n\n<p>后续的按照官方文档操作即可，不再赘述了。</p>\n",
            "tags": [
                "Docker",
                "Ubuntu",
                "安装指南",
                "阿里云",
                "镜像源"
            ]
        },
        {
            "id": "https://nightingalewk.cn/2025/10/09/78.%20Laravel%20%E9%A1%B9%E7%9B%AE%20Docker%20%E5%8C%96%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4%E6%89%8B%E5%86%8C/",
            "url": "https://nightingalewk.cn/2025/10/09/78.%20Laravel%20%E9%A1%B9%E7%9B%AE%20Docker%20%E5%8C%96%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4%E6%89%8B%E5%86%8C/",
            "title": "Laravel 项目 Docker 化部署与运维手册",
            "date_published": "2025-10-09T08:00:00.000Z",
            "content_html": "<p>本文档详细记录了如何将 “土豆食堂” (Lynx) 这个 Laravel 12 项目通过 Docker 进行容器化打包、部署、运行及日常维护。</p>\n<p>个人项目，已开源：<a href=\"https://github.com/NightingaleWK/lynx\">https://github.com/NightingaleWK/lynx</a></p>\n<h2 id=\"一、环境准备\"><a href=\"#一、环境准备\" class=\"headerlink\" title=\"一、环境准备\"></a><strong>一、环境准备</strong></h2><p>在开始之前，请确保您的部署目标机器（例如 Windows 11）已安装并运行 Docker Desktop。</p>\n<h2 id=\"二、项目改造（首次部署需执行）\"><a href=\"#二、项目改造（首次部署需执行）\" class=\"headerlink\" title=\"二、项目改造（首次部署需执行）\"></a><strong>二、项目改造（首次部署需执行）</strong></h2><p>以下文件需要在您本地的项目代码中创建。</p>\n<h3 id=\"1-目录结构\"><a href=\"#1-目录结构\" class=\"headerlink\" title=\"1. 目录结构\"></a><strong>1. 目录结构</strong></h3><p>为了清晰地区分生产环境与 Sail 开发环境的配置，我们将所有生产部署相关的文件都存放在一个新的 docker-prod 目录中。</p>\n<p>在项目根目录下，创建如下的目录和文件结构：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">your-laravel-project/</span><br><span class=\"line\">├── docker-prod/ # &lt;-- 新建，存放所有生产环境配置</span><br><span class=\"line\">│ ├── app/</span><br><span class=\"line\">│ │ └── Dockerfile</span><br><span class=\"line\">│ └── nginx/</span><br><span class=\"line\">│ └── default.conf</span><br><span class=\"line\">├── docker/# &lt;-- 这是 Sail 的开发环境目录 (保留不变)</span><br><span class=\"line\">├── docker-compose.prod.yml# &lt;-- 新建 (注意文件名)</span><br><span class=\"line\">└── .dockerignore# &lt;-- 新建</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-创建核心配置文件\"><a href=\"#2-创建核心配置文件\" class=\"headerlink\" title=\"2. 创建核心配置文件\"></a><strong>2. 创建核心配置文件</strong></h3><p>请根据后续提供的文件内容，在您的项目中创建或替换以下文件。</p>\n<ul>\n<li>docker-compose.prod.yml (服务编排文件)</li>\n<li>docker-prod&#x2F;app&#x2F;Dockerfile (PHP 应用镜像构建文件)</li>\n<li>docker-prod&#x2F;nginx&#x2F;default.conf (Nginx 配置文件)</li>\n<li>.dockerignore (Docker 忽略文件)</li>\n</ul>\n<h3 id=\"3-修改-Laravel-配置-env\"><a href=\"#3-修改-Laravel-配置-env\" class=\"headerlink\" title=\"3. 修改 Laravel 配置 (.env)\"></a><strong>3. 修改 Laravel 配置 (.env)</strong></h3><ol>\n<li>复制 .env.example 为 .env 文件。</li>\n<li><strong>关键修改</strong>：确保数据库和 Redis 的 HOST 指向 Docker Compose 中定义的服务名。</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">APP_ENV=production</span><br><span class=\"line\">APP_DEBUG=false</span><br><span class=\"line\">APP_KEY= # 留空，后续会通过命令生成</span><br><span class=\"line\"></span><br><span class=\"line\">DB_CONNECTION=mysql</span><br><span class=\"line\">DB_HOST=mysql # &lt;-- 必须是 mysql</span><br><span class=\"line\">DB_PORT=3306</span><br><span class=\"line\">DB_DATABASE=lynx# 您的数据库名</span><br><span class=\"line\">DB_USERNAME=sail# 您的用户名</span><br><span class=\"line\">DB_PASSWORD=password# 您的密码</span><br><span class=\"line\"></span><br><span class=\"line\">CACHE_DRIVER=redis</span><br><span class=\"line\">QUEUE_CONNECTION=redis</span><br><span class=\"line\">SESSION_DRIVER=redis</span><br><span class=\"line\"></span><br><span class=\"line\">REDIS_HOST=redis# &lt;-- 必须是 redis</span><br><span class=\"line\">REDIS_PASSWORD=null</span><br><span class=\"line\">REDIS_PORT=6379</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-生成-SSL-证书-局域网-HTTPS\"><a href=\"#4-生成-SSL-证书-局域网-HTTPS\" class=\"headerlink\" title=\"4. 生成 SSL 证书 (局域网 HTTPS)\"></a><strong>4. 生成 SSL 证书 (局域网 HTTPS)</strong></h3><ol>\n<li>在项目根目录下创建目录 docker-prod&#x2F;certs。</li>\n<li>打开终端 (如 Git Bash 或 WSL)，进入项目根目录，执行以下命令：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout docker-prod/ certs/lynx-key.pem -out docker-prod/certs/lynx.pem</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>重要提示</strong>：在执行过程中，当提示输入 Common Name 时，<strong>请输入您部署机器的局域网 IP 地址</strong>（例如 192.168.1.100）。</li>\n<li>执行后，请检查 docker-prod&#x2F;certs 目录下是否已生成 lynx.pem 和 lynx-key.pem 两个文件。</li>\n</ol>\n<h2 id=\"三、部署与初始化流程\"><a href=\"#三、部署与初始化流程\" class=\"headerlink\" title=\"三、部署与初始化流程\"></a><strong>三、部署与初始化流程</strong></h2><h3 id=\"步骤-1：构建并启动所有容器\"><a href=\"#步骤-1：构建并启动所有容器\" class=\"headerlink\" title=\"步骤 1：构建并启动所有容器\"></a><strong>步骤 1：构建并启动所有容器</strong></h3><p>在项目根目录下，打开终端，执行以下命令。此命令会根据 Dockerfile 构建应用镜像，并以后台模式启动所有服务。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --no-cache 确保使用最新的基础镜像，避免缓存问题</span></span><br><span class=\"line\"><span class=\"comment\"># --build 强制重新构建镜像</span></span><br><span class=\"line\">docker-compose -f docker-compose.prod.yml up -d --build --no-cache</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"步骤-2：初始化-Laravel-应用\"><a href=\"#步骤-2：初始化-Laravel-应用\" class=\"headerlink\" title=\"步骤 2：初始化 Laravel 应用\"></a><strong>步骤 2：初始化 Laravel 应用</strong></h3><p>容器首次启动后，数据库是空的，应用也没有配置密钥。我们需要进入 app 容器执行一系列初始化命令。</p>\n<ol>\n<li><strong>生成应用密钥 (APP_KEY)</strong>:</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app php artisan key:generate</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>运行数据库迁移:<br>此命令会根据 database&#x2F;migrations 目录下的文件，在数据库中创建所有需要的数据表（包括 cache 表等）。\\</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app php artisan migrate</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>修正 storage 目录权限:<br>这是解决 “Permission denied” 错误的关键步骤。此命令将容器内的 storage 和 bootstrap&#x2F;cache 目录的所有权交给 php-fpm 的运行用户 www-data。</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app <span class=\"built_in\">chown</span> -R www-data:www-data storage bootstrap/cache</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>（可选）填充测试数据:<br>如果您需要在测试时填充数据，可以运行此命令。请注意，生产环境不应执行此操作。</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --force 参数可以跳过生产环境的确认提示</span></span><br><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app php artisan db:seed --force</span><br></pre></td></tr></table></figure>\n\n<p><em>注：若需填充数据，请确保 Dockerfile 中 composer install 命令<strong>没有</strong>使用 –no-dev 参数，以保证 Faker 等开发包被安装。</em></p>\n<h3 id=\"步骤-3：访问您的应用\"><a href=\"#步骤-3：访问您的应用\" class=\"headerlink\" title=\"步骤 3：访问您的应用\"></a><strong>步骤 3：访问您的应用</strong></h3><p>完成以上步骤后，您的应用已经成功部署并运行。</p>\n<ul>\n<li>打开浏览器，访问 https:&#x2F;&#x2F;&lt;您的部署机器 IP&gt;。</li>\n<li>浏览器会提示证书不安全，请选择“高级” -&gt; “继续前往”。</li>\n<li>您应该能看到 Laravel 的欢迎页面或您的应用首页。</li>\n</ul>\n<h2 id=\"四、日常运维命令\"><a href=\"#四、日常运维命令\" class=\"headerlink\" title=\"四、日常运维命令\"></a><strong>四、日常运维命令</strong></h2><h3 id=\"启动-停止服务\"><a href=\"#启动-停止服务\" class=\"headerlink\" title=\"启动&#x2F;停止服务\"></a><strong>启动&#x2F;停止服务</strong></h3><ul>\n<li><strong>启动所有服务</strong> (后台运行):</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml up -d</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>停止并移除所有容器</strong>:</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml down</span><br></pre></td></tr></table></figure>\n\n<p><em>此操作不会删除数据库和 Redis 的持久化数据。</em></p>\n<h3 id=\"查看状态与日志\"><a href=\"#查看状态与日志\" class=\"headerlink\" title=\"查看状态与日志\"></a><strong>查看状态与日志</strong></h3><ul>\n<li><strong>查看所有容器的运行状态</strong>:</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml ps</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>实时查看所有服务的日志</strong>:</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml logs -f</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>只看特定服务的日志</strong> (例如 app 或 queue-worker):</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml logs -f app</span><br><span class=\"line\">docker-compose -f docker-compose.prod.yml logs -f queue-worker</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"代码更新流程\"><a href=\"#代码更新流程\" class=\"headerlink\" title=\"代码更新流程\"></a><strong>代码更新流程</strong></h3><p>当您通过 git pull 更新了项目代码后：</p>\n<ol>\n<li><strong>重新构建镜像并重启服务</strong>:</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml up -d --build</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>（如果需要）运行新的数据库迁移</strong>:</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app php artisan migrate --force</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>（推荐）清理并重建配置缓存</strong>:</li>\n</ol>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app php artisan optimize:clear</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"执行-Artisan-命令\"><a href=\"#执行-Artisan-命令\" class=\"headerlink\" title=\"执行 Artisan 命令\"></a><strong>执行 Artisan 命令</strong></h3><p>您可以在 app 容器内执行任何 Artisan 命令，语法如下：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose -f docker-compose.prod.yml <span class=\"built_in\">exec</span> app php artisan &lt;您的命令&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"五、完整配置文件代码\"><a href=\"#五、完整配置文件代码\" class=\"headerlink\" title=\"五、完整配置文件代码\"></a><strong>五、完整配置文件代码</strong></h2><p>为了方便您快速部署，以下提供了文中提及的所有配置文件的完整代码。</p>\n<h3 id=\"1-docker-prod-app-Dockerfile\"><a href=\"#1-docker-prod-app-Dockerfile\" class=\"headerlink\" title=\"1. docker-prod&#x2F;app&#x2F;Dockerfile\"></a><strong>1. docker-prod&#x2F;app&#x2F;Dockerfile</strong></h3><p>此文件定义了 PHP 应用容器的构建规则，基于 PHP 8.4 FPM Alpine 镜像，并安装了 Laravel 所需的所有扩展。</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1. 基础镜像升级到 PHP 8.4</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> php:<span class=\"number\">8.4</span>-fpm-alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置工作目录</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /var/www/html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. 优化构建过程：合并依赖安装，并使用 virtual group 以便后续清理</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apk add --no-cache \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    <span class=\"comment\"># 核心系统工具</span></span></span><br><span class=\"line\">    zip \\</span><br><span class=\"line\">    unzip \\</span><br><span class=\"line\">    <span class=\"comment\"># PHP 扩展依赖</span></span><br><span class=\"line\">    libzip-dev \\</span><br><span class=\"line\">    libpng-dev \\</span><br><span class=\"line\">    jpeg-dev \\</span><br><span class=\"line\">    freetype-dev \\</span><br><span class=\"line\">    icu-dev \\</span><br><span class=\"line\">    <span class=\"comment\"># 创建一个名为 .build-deps 的临时构建依赖组</span></span><br><span class=\"line\">    &amp;&amp; apk <span class=\"keyword\">add</span><span class=\"language-bash\"> --no-cache --virtual .build-deps \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    <span class=\"variable\">$PHPIZE_DEPS</span> \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    zlib-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    linux-headers</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. 借鉴 Sail，补全 Laravel 所需的核心扩展</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> docker-php-ext-configure gd --with-freetype --with-jpeg \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; docker-php-ext-install -j$(<span class=\"built_in\">nproc</span>) \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    pdo_mysql \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    bcmath \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    gd \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    exif \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    intl \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    zip \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    pcntl \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    sockets \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; pecl install redis \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; docker-php-ext-enable redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4. 清理工作：删除临时的构建依赖，减小镜像体积</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apk del .build-deps</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 Composer</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=composer:latest /usr/bin/composer /usr/bin/composer</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 拷贝 composer 文件并安装依赖</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> composer.json composer.lock ./</span></span><br><span class=\"line\"><span class=\"comment\"># 生产环境优化：不安装开发依赖，并优化自动加载</span></span><br><span class=\"line\"><span class=\"comment\"># 注意：如果需要在容器内运行 seeder，请暂时移除 --no-dev 参数并重新构建</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> composer install --no-interaction --no-plugins --no-scripts --prefer-dist --no-dev -o</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 拷贝项目代码</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> . .</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意：权限问题将在首次启动后通过 exec 命令解决，以确保与宿主机挂载的目录权限正确</span></span><br><span class=\"line\"><span class=\"comment\"># RUN chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 暴露 9000 端口</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">9000</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-docker-prod-nginx-default-conf\"><a href=\"#2-docker-prod-nginx-default-conf\" class=\"headerlink\" title=\"2. docker-prod&#x2F;nginx&#x2F;default.conf\"></a><strong>2. docker-prod&#x2F;nginx&#x2F;default.conf</strong></h3><p>此文件定义了 Nginx 的配置规则，实现了 HTTP 到 HTTPS 的自动重定向，并配置了 SSL 证书和 PHP-FPM 的转发规则。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> _; <span class=\"comment\"># 匹配任何主机名</span></span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">301</span> https://<span class=\"variable\">$host</span><span class=\"variable\">$request_uri</span>; <span class=\"comment\"># 将所有 HTTP 请求重定向到 HTTPS</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> _;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># SSL 证书配置</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/certs/lynx.pem;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/certs/lynx-key.pem;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_protocols</span> TLSv1.<span class=\"number\">2</span> TLSv1.<span class=\"number\">3</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">root</span> /var/www/html/public;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.php index.html;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">try_files</span> <span class=\"variable\">$uri</span> <span class=\"variable\">$uri</span>/ /index.php?<span class=\"variable\">$query_string</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">try_files</span> <span class=\"variable\">$uri</span> =<span class=\"number\">404</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_split_path_info</span><span class=\"regexp\"> ^(.+\\.php)(/.+)$</span>;</span><br><span class=\"line\">        <span class=\"comment\"># 注意这里的 fastcgi_pass 指向的是 app 服务的名称和端口</span></span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span> app:<span class=\"number\">9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span> index.php;</span><br><span class=\"line\">        <span class=\"attribute\">include</span> fastcgi_params;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span> SCRIPT_FILENAME <span class=\"variable\">$document_root</span><span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span> PATH_INFO <span class=\"variable\">$fastcgi_path_info</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> <span class=\"regexp\">~ /\\.ht</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-docker-compose-prod-yml\"><a href=\"#3-docker-compose-prod-yml\" class=\"headerlink\" title=\"3. docker-compose.prod.yml\"></a><strong>3. docker-compose.prod.yml</strong></h3><p>此文件是 Docker Compose 的服务编排配置，定义了应用所需的所有服务：PHP 应用、Nginx、MySQL、Redis 和队列处理器。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"comment\"># 1. Laravel 应用服务 (PHP-FPM)</span></span><br><span class=\"line\">  <span class=\"attr\">app:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span></span><br><span class=\"line\">      <span class=\"attr\">context:</span> <span class=\"string\">.</span></span><br><span class=\"line\">      <span class=\"attr\">dockerfile:</span> <span class=\"string\">docker-prod/app/Dockerfile</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">lynx_app</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">working_dir:</span> <span class=\"string\">/var/www/html</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./:/var/www/html</span></span><br><span class=\"line\">      <span class=\"comment\"># 使用匿名卷保护镜像中已构建的 vendor 和 node_modules 目录不被宿主机覆盖</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/www/html/vendor</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/www/html/node_modules</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx-network</span></span><br><span class=\"line\">    <span class=\"comment\"># 确保 App 在数据库和 Redis 健康后才启动</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"attr\">mysql:</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_healthy</span></span><br><span class=\"line\">      <span class=\"attr\">redis:</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_healthy</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 2. Nginx 服务</span></span><br><span class=\"line\">  <span class=\"attr\">nginx:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx:alpine</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">lynx_nginx</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;80:80&quot;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;443:443&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./:/var/www/html</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./docker-prod/nginx/default.conf:/etc/nginx/conf.d/default.conf</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./docker-prod/certs:/etc/nginx/certs</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">app</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx-network</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 3. MySQL 数据库服务</span></span><br><span class=\"line\">  <span class=\"attr\">mysql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mysql:8.0</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">lynx_mysql</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_DATABASE:</span> <span class=\"string\">$&#123;DB_DATABASE&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"string\">$&#123;DB_PASSWORD&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_PASSWORD:</span> <span class=\"string\">$&#123;DB_PASSWORD&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_USER:</span> <span class=\"string\">$&#123;DB_USERNAME&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx_mysql_data:/var/lib/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3306:3306&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx-network</span></span><br><span class=\"line\">    <span class=\"comment\"># 从 Sail 借鉴的健康检查，确保数据库服务真正可用</span></span><br><span class=\"line\">    <span class=\"attr\">healthcheck:</span></span><br><span class=\"line\">      <span class=\"attr\">test:</span> [<span class=\"string\">&quot;CMD&quot;</span>, <span class=\"string\">&quot;mysqladmin&quot;</span>, <span class=\"string\">&quot;ping&quot;</span>, <span class=\"string\">&quot;-p$&#123;DB_PASSWORD&#125;&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">retries:</span> <span class=\"number\">3</span></span><br><span class=\"line\">      <span class=\"attr\">timeout:</span> <span class=\"string\">5s</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 4. Redis 服务</span></span><br><span class=\"line\">  <span class=\"attr\">redis:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis:alpine</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">lynx_redis</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx_redis_data:/data</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx-network</span></span><br><span class=\"line\">    <span class=\"comment\"># 从 Sail 借鉴的健康检查，确保 Redis 服务真正可用</span></span><br><span class=\"line\">    <span class=\"attr\">healthcheck:</span></span><br><span class=\"line\">      <span class=\"attr\">test:</span> [<span class=\"string\">&quot;CMD&quot;</span>, <span class=\"string\">&quot;redis-cli&quot;</span>, <span class=\"string\">&quot;ping&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">retries:</span> <span class=\"number\">3</span></span><br><span class=\"line\">      <span class=\"attr\">timeout:</span> <span class=\"string\">5s</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 5. Laravel Queue Worker 服务</span></span><br><span class=\"line\">  <span class=\"attr\">queue-worker:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span></span><br><span class=\"line\">      <span class=\"attr\">context:</span> <span class=\"string\">.</span></span><br><span class=\"line\">      <span class=\"attr\">dockerfile:</span> <span class=\"string\">docker-prod/app/Dockerfile</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">lynx_queue_worker</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> <span class=\"string\">php</span> <span class=\"string\">artisan</span> <span class=\"string\">queue:work</span> <span class=\"string\">--verbose</span> <span class=\"string\">--tries=3</span> <span class=\"string\">--timeout=90</span></span><br><span class=\"line\">    <span class=\"attr\">working_dir:</span> <span class=\"string\">/var/www/html</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./:/var/www/html</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/www/html/vendor</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/www/html/node_modules</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">lynx-network</span></span><br><span class=\"line\">    <span class=\"comment\"># 确保 Worker 也在数据库和 Redis 健康后才启动</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"attr\">mysql:</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_healthy</span></span><br><span class=\"line\">      <span class=\"attr\">redis:</span></span><br><span class=\"line\">        <span class=\"attr\">condition:</span> <span class=\"string\">service_healthy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义网络</span></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">lynx-network:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义数据卷 (用于持久化)</span></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">lynx_mysql_data:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">local</span></span><br><span class=\"line\">  <span class=\"attr\">lynx_redis_data:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">local</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-dockerignore\"><a href=\"#4-dockerignore\" class=\"headerlink\" title=\"4. .dockerignore\"></a><strong>4. .dockerignore</strong></h3><p>此文件用于指定在构建 Docker 镜像时需要忽略的文件和目录，可以显著减小镜像体积并提高构建速度。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.git</span><br><span class=\"line\">.github</span><br><span class=\"line\">.gitignore</span><br><span class=\"line\"></span><br><span class=\"line\">.env</span><br><span class=\"line\">.env.example</span><br><span class=\"line\"></span><br><span class=\"line\">/vendor/</span><br><span class=\"line\">/node_modules/</span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose.yml</span><br><span class=\"line\">/docker/</span><br><span class=\"line\"></span><br><span class=\"line\">.idea</span><br><span class=\"line\">.vscode</span><br><span class=\"line\">*.DS_Store</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"六、总结\"><a href=\"#六、总结\" class=\"headerlink\" title=\"六、总结\"></a><strong>六、总结</strong></h2><p>至此将 Laravel 项目通过 Docker 进行生产环境部署的完整流程已介绍完毕。这套方案具有以下特点：</p>\n<ul>\n<li>✅ <strong>容器化</strong>：所有服务通过 Docker 隔离运行，环境一致性强</li>\n<li>✅ <strong>易于部署</strong>：一键构建和启动，减少环境配置问题</li>\n<li>✅ <strong>生产优化</strong>：包含 SSL 支持、健康检查、自动重启等生产级特性</li>\n<li>✅ <strong>易于维护</strong>：提供完整的日常运维命令，代码更新流程清晰</li>\n<li>✅ <strong>可扩展性</strong>：基于 Docker Compose，方便后续添加其他服务</li>\n</ul>\n<p>如果在部署过程中遇到问题，请检查：</p>\n<ol>\n<li>Docker Desktop 是否正常运行</li>\n<li>端口 80、443、3306 是否被占用</li>\n<li>.env 文件中的配置是否正确</li>\n<li>storage 目录权限是否正确设置</li>\n</ol>\n",
            "tags": [
                "Docker",
                "Laravel",
                "容器化",
                "部署",
                "运维"
            ]
        }
    ]
}